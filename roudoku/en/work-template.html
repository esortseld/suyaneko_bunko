<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>English Text – Suyaneko Bunko</title>
<meta name="description" content="Suyaneko Bunko: English text reader.">
<!-- 可愛い丸ゴ系：Nunito（英字）＋ M PLUS Rounded 1c（日本語フォールバック） -->
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<!-- 既存のNotoも利用するなら↓を残してOK（不要なら削除可） -->
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root{
    /* 初期値：丸めフォントをデフォルトにしています */
    --ff: "Nunito", "M PLUS Rounded 1c", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
    --fs: 18px; --lh: 1.9; --maxw: 42rem;
    --ink:#222; --sub:#666; --line:#eee; --bg:#faf8f6; --card:#fff; --btn:#f3f1ef;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:var(--ff)}
  header{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,#f8efe8,transparent);border-bottom:1px solid var(--line)}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:14px 16px}
  .bar{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .back{margin-right:auto}
  a.link{color:#345;text-decoration:none;border-bottom:1px solid #ccd}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:8px 10px;border:1px solid var(--line);border-radius:10px;background:var(--btn)}
  select, button{border:1px solid var(--line);background:#fff;border-radius:8px;padding:6px 8px}
  button{cursor:pointer}
  main{padding:22px 16px}
  .reader{
    max-width:var(--maxw);
    margin:0 auto;
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
    white-space:pre-wrap;
    word-break:break-word;
    font-family:var(--ff);
    font-size:var(--fs);
    line-height:var(--lh);
  }
  .meta{max-width:var(--maxw);margin:0 auto 10px;color:var(--sub)}
  @media (prefers-color-scheme: dark){
    :root{--ink:#eee;--sub:#aaa;--line:#2a2a2a;--bg:#0f0e0e;--card:#151515;--btn:#1a1a1a}
    a.link{color:#cfe2ff;border-bottom-color:#2a3f66}
    select, button{background:#111;color:#eee;border-color:#333}
  }
</style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="bar">
      <a class="link back" href="../index.html">← Back to Roudoku</a>

      <!-- フォント選択 -->
      <label class="pill">
        Font
        <select id="fontSel" title="Font family">
          <option value="rounded" selected>Rounded (cute)</option>
          <option value="sans">Sans (Noto Sans / System)</option>
          <option value="serif">Serif (Noto Serif / Mincho)</option>
          <option value="system">System only</option>
          <option value="yu-mincho">"游明朝 / Yu Mincho"</option>
          <option value="hiragino-mincho">"ヒラギノ明朝 / Hiragino Mincho"</option>
          <option value="meiryo">メイリオ / Meiryo</option>
        </select>
      </label>

      <!-- 文字サイズ -->
      <label class="pill">
        Size
        <button type="button" id="smaller" aria-label="Smaller">A−</button>
        <button type="button" id="larger"  aria-label="Larger">A＋</button>
      </label>

      <!-- 行間 -->
      <label class="pill">
        Line
        <select id="lineSel" title="Line height">
          <option value="1.6">1.6</option>
          <option value="1.8">1.8</option>
          <option value="1.9" selected>1.9</option>
          <option value="2.0">2.0</option>
          <option value="2.2">2.2</option>
        </select>
      </label>
    </div>
  </div>
</header>

<main>
  <p class="meta" id="workMeta"></p>
  <article id="reader" class="reader" aria-live="polite">Loading…</article>
</main>

<script>
  // ---- クエリからID取得（例: ?id=53452） ----
  const params = new URLSearchParams(location.search);
  const id = params.get('id');
  const TEXT_URL = id ? `./texts/${id}.txt` : null;

  // ---- 保存設定 ----
  const rootStyle = document.documentElement.style;
  const PREF_KEY = 'sb_reader_prefs';
  const defaults = { font:'rounded', size:18, line:'1.9' }; // ← デフォルトを rounded

  function loadPrefs(){
    try { return Object.assign({}, defaults, JSON.parse(localStorage.getItem(PREF_KEY)||'{}')); }
    catch(_){ return {...defaults}; }
  }
  function savePrefs(p){ localStorage.setItem(PREF_KEY, JSON.stringify(p)); }

  function applyFont(key){
    const stacks = {
      /* 丸めで可愛い：英字Nunito＋日本語はM PLUS Rounded 1c */
      rounded: '"Nunito","M PLUS Rounded 1c", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Meiryo, sans-serif',
      sans: '"Noto Sans JP", system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif',
      serif: '"Noto Serif JP", "Yu Mincho", "Hiragino Mincho ProN", "Hiragino Mincho Pro", serif',
      system: 'system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", Meiryo, sans-serif',
      'yu-mincho': '"Yu Mincho", "游明朝", "Hiragino Mincho ProN", serif',
      'hiragino-mincho': '"Hiragino Mincho ProN", "Hiragino Mincho Pro", "Yu Mincho", serif',
      meiryo: 'Meiryo, "Noto Sans JP", system-ui, sans-serif'
    };
    rootStyle.setProperty('--ff', stacks[key] || stacks.rounded);
  }
  function applySize(px){ rootStyle.setProperty('--fs', px + 'px'); }
  function applyLine(h){ rootStyle.setProperty('--lh', h); }

  const prefs = loadPrefs();
  applyFont(prefs.font); applySize(prefs.size); applyLine(prefs.line);

  // UI 初期状態
  fontSel.value = prefs.font;
  lineSel.value = prefs.line;

  // 操作ハンドラ
  fontSel.addEventListener('change', e => { prefs.font = e.target.value; applyFont(prefs.font); savePrefs(prefs); });
  smaller.addEventListener('click', () => { prefs.size = Math.max(12, Math.round((prefs.size - 1) * 10) / 10); applySize(prefs.size); savePrefs(prefs); });
  larger.addEventListener('click', () => { prefs.size = Math.min(36, Math.round((prefs.size + 1) * 10) / 10); applySize(prefs.size); savePrefs(prefs); });
  lineSel.addEventListener('change', e => { prefs.line = e.target.value; applyLine(prefs.line); savePrefs(prefs); });

  // ---- テキスト読込 ----
  const reader = document.getElementById('reader');
  const meta = document.getElementById('workMeta');

  if(!TEXT_URL){
    reader.textContent = 'ID is missing. Use ?id=53452 etc.';
  }else{
    fetch(TEXT_URL, {cache:'no-store'})
      .then(r => r.ok ? r.text() : Promise.reject(r.status))
      .then(txt => {
        txt = txt.replace(/\r\n/g, '\n');
        reader.textContent = txt;
        meta.textContent = `Source: texts/${id}.txt`;
      })
      .catch(err => { reader.textContent = 'Failed to load text: ' + err; });
  }
</script>
</body>
</html>
